import React, { useState, useEffect, useCallback, useRef } from 'react';
import { MessageCircle, TrendingUp, Tv, Wallet, ArrowLeft, Send, Volume2, Home, BarChart2 } from 'lucide-react';
import * as Tone from 'tone'; // Import Tone.js

// Custom Alert Dialog Component
const AlertDialog = ({ title, message, onClose }) => {
  return (
    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full transform transition-all duration-300 scale-100 opacity-100">
        <h3 className="text-xl font-bold text-gray-800 mb-4 text-center">{title}</h3>
        <p className="text-gray-600 mb-6 text-center">{message}</p>
        <button
          onClick={onClose}
          className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-xl font-bold hover:from-purple-700 hover:to-indigo-700 transition-all duration-300 shadow-md"
        >
          확인
        </button>
      </div>
    </div>
  );
};

const YunaStockGame = () => {
  // 게임 상태
  const [currentApp, setCurrentApp] = useState('home');
  const [gameStage, setGameStage] = useState('initialIntro'); // Initial stage is now 'initialIntro'
  const [selectedEnding, setSelectedEnding] = useState(null);
  const [recentGoodNews, setRecentGoodNews] = useState(false);
  const initialAssets = 5000000; // 초기 자산 설정

  // Audio Players
  const bgMusicPlayer = useRef(null);
  const buttonClickPlayer = useRef(null);
  const transactionPlayer = useRef(null);

  // Initialize audio players
  useEffect(() => {
    // Background Music
    bgMusicPlayer.current = new Tone.Player({
      url: "https://github.com/heyrichoi/yuna/raw/refs/heads/main/SellBuyMusic%20-%20%ED%95%98%EC%99%80%EC%9D%B4%EC%9D%98%20%EB%B3%84%EB%82%B4%EB%A6%AC%EB%8A%94%20%EB%B0%A4.mp3",
      loop: true,
      volume: -15 // Adjust volume as needed
    }).toDestination();

    // Button Click Sound
    buttonClickPlayer.current = new Tone.Player({
      url: "https://github.com/heyrichoi/yuna/raw/refs/heads/main/Blop%20Sound.mp3",
      volume: -10 // Adjust volume as needed
    }).toDestination();

    // Transaction Sound
    transactionPlayer.current = new Tone.Player({
      url: "https://github.com/heyrichoi/yuna/raw/refs/heads/main/Coin%201.mp3",
      volume: -5 // Adjust volume as needed
    }).toDestination();

    // Clean up on unmount
    return () => {
      bgMusicPlayer.current?.dispose();
      buttonClickPlayer.current?.dispose();
      transactionPlayer.current?.dispose();
    };
  }, []);

  // Start background music when game stage is 'playing'
  useEffect(() => {
    if (gameStage === 'playing') {
      // Ensure Tone.js context is started and player is loaded before starting music
      if (bgMusicPlayer.current && bgMusicPlayer.current.loaded && bgMusicPlayer.current.state !== 'started') {
        bgMusicPlayer.current.start();
      }
    } else {
      if (bgMusicPlayer.current && bgMusicPlayer.current.state === 'started') {
        bgMusicPlayer.current.stop();
      }
    }
  }, [gameStage]);

  // Function to play button click sound
  const playButtonClickSound = useCallback(() => {
    if (buttonClickPlayer.current && buttonClickPlayer.current.loaded) { // Check if loaded
      buttonClickPlayer.current.stop(); // Stop if already playing to allow rapid clicks
      buttonClickPlayer.current.start();
    }
  }, []);

  // Function to play transaction sound
  const playTransactionSound = useCallback(() => {
    if (transactionPlayer.current && transactionPlayer.current.loaded) { // Check if loaded
      transactionPlayer.current.stop(); // Stop if already playing
      transactionPlayer.current.start();
    }
  }, []);

  // 배경 이미지 상태 관리
  const getBackgroundImage = () => {
    // 사용자 요청에 따라 배경 이미지 로직 변경:
    // 1. 퇴사 이후 (isEmployee가 false)에는 https://imgur.com/MeIYn0J.png 고정
    // 2. 그 외의 경우 (기본 메인 화면)에는 https://i.imgur.com/k3qPvGy.png 고정
    if (!isEmployee) {
      return 'https://i.imgur.com/MeIYn0J.png'; // 회사 퇴사 이후 고정 이미지
    }
    return 'https://i.imgur.com/k3qPvGy.png'; // 기본 메인 화면 고정 이미지
  };
  
  // 플레이어 상태
  const [cash, setCash] = useState(initialAssets);
  const [stress, setStress] = useState(20);
  const [knowledge, setKnowledge] = useState(10);
  const [isEmployee, setIsEmployee] = useState(true);
  const [gameDay, setGameDay] = useState(1);
  const [portfolio, setPortfolio] = useState({});
  
  // 주식 데이터와 히스토리
  const [stocks, setStocks] = useState({
    '삼성전자': { price: 68000, change: 0, history: [68000] },
    'SK하이닉스': { price: 85000, change: 0, history: [85000] },
    'NAVER': { price: 240000, change: 0, history: [240000] },
    '카카오': { price: 65000, change: 0, history: [65000] },
    'LG화학': { price: 520000, change: 0, history: [520000] },
    '현대자동차': { price: 180000, change: 0, history: [180000] }
  });
  
  // TV 관련
  const [selectedChannel, setSelectedChannel] = useState(null);
  const [tvMessage, setTvMessage] = useState('');
  
  // 메시지 관련
  const [messages, setMessages] = useState({
    individual: [],
    investors: [],
    company: []
  });
  const [unreadCounts, setUnreadCounts] = useState({
    individual: 0,
    investors: 0,
    company: 0
  });
  const [selectedChat, setSelectedChat] = useState(null);
  const [inputMessage, setInputMessage] = useState('');
  const [waitingForResponse, setWaitingForResponse] = useState(null);

  // Sender profile pictures
  const senderProfiles = {
    '친구 민지': 'https://imgur.com/zhyQMSE.jpg', // Provided image 1
    '엄마': 'https://imgur.com/SqjZMsh.jpg', // Provided image 2
    '대학 선배': 'https://imgur.com/0W7n2v1.jpg', // Provided image 3
    '투자고수': 'https://placehold.co/40x40/FFD700/000000?text=고수',
    '주린이123': 'https://placehold.co/40x40/FFD700/000000?text=주린이',
    '부동산왕': 'https://placehold.co/40x40/FFD700/000000?text=부왕',
    '회사': 'https://placehold.co/40x40/FFD700/000000?text=회사',
    '팀장': 'https://placehold.co/40x40/FFD700/000000?text=팀장',
    '동료 수진': 'https://placehold.co/40x40/FFD700/000000?text=수진',
    '시스템': 'https://placehold.co/40x40/FFD700/000000?text=시스템',
    '자동응답': 'https://placehold.co/40x40/FFD700/000000?text=자동',
    '유나': 'https://imgur.com/Omc3nbn.jpg' // Yuna's own logo
  };
  
  // 부동산 관련
  const [realEstate, setRealEstate] = useState({});
  const [realEstateData, setRealEstateData] = useState({
    '강남 아파트': { price: 800000000, change: 0, rentYield: 0.02, description: '강남구 대치동 84㎡' },
    '홍대 상가': { price: 300000000, change: 0, rentYield: 0.04, description: '마포구 홍익로 1층 상가' },
    '판교 오피스텔': { price: 500000000, change: 0, rentYield: 0.03, description: '분당구 판교역 도보 5분' },
    '부산 빌라': { price: 150000000, change: 0, rentYield: 0.05, description: '해운대구 전용 23㎡' },
    '평창동 단독주택': { price: 1200000000, change: 0, rentYield: 0.015, description: '종로구 평창동 330㎡' },
    '송도 신축 아파트': { price: 600000000, change: 0, rentYield: 0.025, description: '연수구 송도국제도시' },
    '제주 펜션': { price: 400000000, change: 0, rentYield: 0.06, description: '서귀포시 해변가 펜션' },
    '인천공항 근처 상가': { price: 250000000, change: 0, rentYield: 0.045, description: '중구 공항로 임대상가' }
  });
  
  // 시장 영향 시스템
  const [marketInfluences, setMarketInfluences] = useState({});
  const [currentStockView, setCurrentStockView] = useState(null);

  // Alert Dialog State
  const [showAlertDialog, setShowAlertDialog] = useState(false);
  const [alertDialogContent, setAlertDialogContent] = useState({ title: '', message: '' });

  // TV 채널 데이터
  const tvChannels = {
    gossip: {
      name: '찌라시 뉴스',
      icon: '📰',
      description: '하이리스크 하이리턴 정보',
      messages: [
        { text: '🔥 "삼성전자 내부 정보! 대박 날 것 같아요!"', impact: { '삼성전자': 0.15 }, accuracy: 0.3 },
        { text: '⚡ "카카오 관련 루머가 돌고 있습니다..."', impact: { '카카오': -0.08 }, accuracy: 0.4 },
        { text: '💥 "이번 주 SK하이닉스가 폭등한다는 소문!"', impact: { 'SK하이닉스': 0.12 }, accuracy: 0.25 },
        { text: '🚨 "NAVER 주가 조작설? 진실은 무엇일까요?"', impact: { 'NAVER': -0.10 }, accuracy: 0.2 }
      ]
    },
    professional: {
      name: '경제 전문채널',
      icon: '📊',
      description: '검증된 전문 정보',
      messages: [
        { text: '📈 "분석 결과, 반도체 업종이 상승세를 보이고 있습니다."', impact: { '삼성전자': 0.05, 'SK하이닉스': 0.06 }, accuracy: 0.8 },
        { text: '📉 "플랫폼 기업들의 실적 우려가 커지고 있습니다."', impact: { 'NAVER': -0.04, '카카오': -0.03 }, accuracy: 0.75 },
        { text: '💼 "자동차 업계의 전기차 전환이 가속화되고 있습니다."', impact: { '현대자동차': 0.08 }, accuracy: 0.9 },
        { text: '🏭 "화학 업종의 원자재 가격 상승이 우려됩니다."', impact: { 'LG화학': -0.05 }, accuracy: 0.85 }
      ]
    },
    market: {
      name: '시장 현황',
      icon: '📋',
      description: '단순 시장 정보',
      messages: [
        { text: '📊 "코스피 지수 현재 2,450포인트입니다."', impact: {}, accuracy: 1.0 },
        { text: '💹 "거래량이 평소보다 20% 증가했습니다."', impact: {}, accuracy: 1.0 },
        { text: '📈 "외국인 순매수세가 이어지고 있습니다."', impact: {}, accuracy: 1.0 },
        { text: '💱 "달러/원 환율 1,320원대에서 거래 중입니다."', impact: {}, accuracy: 1.0 }
      ]
    },
    education: {
      name: '투자 교육',
      icon: '�',
      description: '투자 지식 향상',
      messages: [
        { text: '📚 "분산투자의 중요성을 알아보겠습니다."', impact: {}, accuracy: 1.0 },
        { text: '🧮 "PER과 PBR 지표 활용법을 설명드리겠습니다."', impact: {}, accuracy: 1.0 },
        { text: '📖 "장기투자 vs 단기투자, 어떤 것이 좋을까요?"', impact: {}, accuracy: 1.0 },
        { text: '💡 "리스크 관리의 핵심 원칙들을 살펴보겠습니다."', impact: {}, accuracy: 1.0 }
      ]
    },
    entertainment: {
      name: '연예 채널',
      icon: '🎭',
      description: '스트레스 해소',
      messages: [
        { text: '🎬 "오늘의 연예 뉴스를 전해드립니다."', impact: {}, accuracy: 1.0 },
        { text: '🎵 "인기 아이돌 그룹의 새 앨범이 발매됩니다."', impact: {}, accuracy: 1.0 },
        { text: '📺 "화제의 드라마 시청률이 20%를 돌파했습니다."', impact: {}, accuracy: 1.0 },
        { text: '🎪 "주말 예능 프로그램 특집 방송이 있습니다."', impact: {}, accuracy: 1.0 }
      ]
    }
  };

  // 엔딩 데이터
  const endings = {
    bankruptcy: {
      title: '💸 파산...',
      description: '모든 돈을 잃고 빈털터리가 되었습니다.',
      image: '😭',
      backgroundImage: 'https://i.imgur.com/0u6807w.png',
      condition: () => getTotalAssets() < 500000,
      epilogue: {
        title: '유나의 독백',
        content: '돈을 다 잃었지만... 배운 것도 많았어. 이제 다시 시작해야겠어. 회사로 다시 돌아가서 차근차근 다시 모아보자. 이번엔 더 신중하게...',
        afterLife: '유나는 다시 회사로 돌아가 성실하게 일하며 조금씩 저축을 시작했다. 투자의 쓴맛을 봤지만, 포기하지 않고 공부하며 준비하고 있다.'
      }
    },
    backToWork: {
      title: '🏢 복직',
      description: '투자로 큰 수익은 없었지만 안정적인 직장으로 돌아갑니다.',
      image: '👔',
      backgroundImage: 'https://i.imgur.com/RrHjd3F.png',
      condition: () => getTotalAssets() >= 3000000 && getTotalAssets() < 50000000 && stress >= 80,
      epilogue: {
        title: '유나의 독백',
        content: '투자는 생각보다 어려웠어. 스트레스도 너무 많이 받았고... 그래도 완전히 망하지는 않았으니 다행이야. 회사 일이 그립네. 안정적인 월급이 최고인 것 같아.',
        afterLife: '유나는 회사로 복귀하여 안정적인 삶을 선택했다. 가끔 주식 뉴스를 보면서도 "역시 월급쟁이가 최고야"라고 중얼거린다.'
      }
    },
    pyeongchangHouse: {
      title: '🏘️ 평창동 생활',
      description: '평창동 단독주택을 구매하고 여유로운 삶을 시작합니다.',
      image: '🏡',
      backgroundImage: 'https://i.imgur.com/XHqHQgA.png',
      condition: () => realEstate['평창동 단독주택'] > 0,
      epilogue: {
        title: '유나의 독백',
        content: '평창동 집이 정말 좋아. 넓은 마당에서 차 한 잔 마시며 미래를 계획해보니 마음이 평온해져. 이제 시작이야. 더 큰 꿈을 향해 차근차근 나아가자.',
        afterLife: '평창동 단독주택에서 여유로운 삶을 즐기는 유나. 매일 아침 마당에서 커피를 마시며 새로운 투자 기회를 모색한다. 이웃들과의 모임에서는 "투자의 여왕"으로 불린다.'
      }
    },
    signielLife: {
      title: '🏙️ 시그니엘의 여왕',
      description: '주식 투자로 대성공하여 시그니엘에서 럭셔리한 삶을 즐깁니다.',
      image: '👑',
      backgroundImage: 'https://i.imgur.com/krLsjrs.png',
      condition: () => {
        const stockValue = Object.entries(portfolio).reduce((total, [stock, shares]) => {
          return total + (stocks[stock]?.price || 0) * shares;
        }, 0);
        return getTotalAssets() >= 500000000 && stockValue > getTotalAssets() * 0.6;
      },
      epilogue: {
        title: '유나의 독백',
        content: '시그니엘 최고층에서 내려다보는 서울의 야경이 정말 아름다워. 주식 투자로 이런 삶을 살 수 있게 되다니... 꿈만 같아. 이제 더 많은 사람들에게 투자의 기회를 알려주고 싶어.',
        afterLife: '시그니엘 펜트하우스에 거주하는 유나. 매일 아침 한강을 바라보며 글로벌 주식 시장을 체크한다. 유튜브 채널 "유나의 주식 라이프"를 운영하며 투자 노하우를 공유하고 있다.'
      }
    },
    hawaiiLife: {
      title: '🏝️ 하와이 생활',
      description: '부동산 투자로 성공하여 하와이에서 자유로운 삶을 즐깁t니다.',
      image: '🌺',
      backgroundImage: 'https://i.imgur.com/W8xi5Qm.png',
      condition: () => {
        const realEstateValue = Object.entries(realEstate).reduce((total, [property, quantity]) => {
          return total + (realEstateData[property]?.price || 0) * quantity;
        }, 0);
        return getTotalAssets() >= 300000000 && realEstateValue > getTotalAssets() * 0.5;
      },
      epilogue: {
        title: '유나의 독백',
        content: '하와이 해변에서 보는 일몰이 정말 환상적이야. 부동산 임대료만으로도 이렇게 여유롭게 살 수 있다니... 한국의 빌딩들이 나를 먹여 살리고 있어. 이제 진짜 자유를 얻었어.',
        afterLife: '하와이 와이키키 해변가 콘도에서 생활하는 유나. 매달 한국에서 들어오는 임대료로 여유로운 삶을 즐긴다. 서핑과 요가를 배우며 진정한 라이프스타일을 만끽하고 있다.'
      }
    },
    addictedTrader: {
      title: '🎲 투자 중독',
      description: '손실을 봤지만 투자를 포기하지 못하고 계속 도전합니다.',
      image: '🔥',
      backgroundImage: 'https://i.imgur.com/55TCUE2.png',
      condition: () => getTotalAssets() < 8000000 && stress >= 90 && knowledge >= 80,
      epilogue: {
        title: '유나의 독백',
        content: '돈은 많이 잃었지만... 이 스릴을 포기할 수 없어. 다음엔 분명 대박이 날 거야. 이렇게 많이 배웠는데 포기할 수는 없지. 한 번 더, 딱 한 번만 더!',
        afterLife: '작은 원룸에서 여전히 투자에 몰두하는 유나. 컵라면으로 끼니를 때우며 차트를 분석한다. "이번엔 다르다"는 말을 입에 달고 살지만, 그 열정만큼은 식지 않았다.'
      }
    },
    megaSuccess: {
      title: '💎 투자의 신',
      description: '10억원을 달성한 진정한 투자의 달인이 되었습니다!',
      image: '🚀',
      backgroundImage: 'https://i.imgur.com/9lVUHT1.png',
      condition: () => getTotalAssets() >= 1000000000,
      epilogue: {
        title: '유나의 독백',
        content: '10억이라니... 정말 믿기지 않아. 이제 진짜 투자의 신이 된 기분이야. 하지만 여기서 끝이 아니야. 더 많은 사람들이 경제적 자유를 얻을 수 있도록 도와주고 싶어.',
        afterLife: '투자회사 "유나 캐피털"을 설립한 유나. 개인 투자자들을 위한 교육 프로그램을 운영하며, 매년 수십억 원의 수익을 올리고 있다. Forbes 선정 "주목할 만한 여성 투자자"에 선정되었다.'
      }
    }
  };

  // 총자산 계산
  const getTotalAssets = useCallback(() => {
    const portfolioValue = Object.entries(portfolio).reduce((total, [stock, shares]) => {
      return total + (stocks[stock]?.price || 0) * shares;
    }, 0);
    
    const realEstateValue = Object.entries(realEstate).reduce((total, [property, quantity]) => {
      return total + (realEstateData[property]?.price || 0) * quantity;
    }, 0);
    
    return cash + portfolioValue + realEstateValue;
  }, [cash, portfolio, stocks, realEstate, realEstateData]);

  // 실시간 수익률 계산
  const getCurrentReturnRate = useCallback(() => {
    const totalAssets = getTotalAssets();
    if (initialAssets === 0) return 0; // Prevent division by zero
    return ((totalAssets - initialAssets) / initialAssets) * 100;
  }, [getTotalAssets, initialAssets]);

  // 메시지 추가 함수
  const addMessage = (type, sender, content, isUser = false, choices = null) => {
    const newMessage = {
      id: Date.now(),
      sender,
      content,
      time: new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }), // 한국 시간 형식
      isUser,
      choices
    };
    
    setMessages(prev => ({
      ...prev,
      [type]: [...prev[type], newMessage]
    }));
    
    if (!isUser) {
      setUnreadCounts(prev => ({
        ...prev,
        [type]: prev[type] + 1
      }));
      
      if (choices) {
        setWaitingForResponse({ type, messageId: newMessage.id });
      }
    }
  };

  // 선택지 응답
  const selectChoice = (choice, originalMessageId) => {
    playButtonClickSound(); // Play sound on choice selection
    addMessage(waitingForResponse.type, '유나', choice, true);
    
    // 좋은 정보에 대한 긍정적 반응일 때 배경 변경
    if (choice.includes('좋은 정보 감사해요') || choice.includes('더 자세히 알려주세요')) {
      setRecentGoodNews(true);
      setTimeout(() => setRecentGoodNews(false), 10000); // 10초 후 원래 배경으로
    }
    
    setWaitingForResponse(null);
    
    // 선택에 따른 자동 응답
    setTimeout(() => {
      const responses = [
        '네, 알겠습니다!',
        '좋은 정보 감사합니다!',
        '현명한 판단이네요.',
        '저도 그렇게 생각해요!',
        '더 자세히 알려주세요!',
        '흥미롭네요.',
        '고민해볼게요.',
        '알겠습니다, 참고할게요.',
        '정말 기대되네요!',
        '최고의 선택입니다!',
        '힘내세요!',
        '화이팅!',
        '성투하세요!', // 성공 투자
        '대박나세요!',
        '조심하세요!'
      ];
      const response = responses[Math.floor(Math.random() * responses.length)]; // Random response
      addMessage(waitingForResponse?.type || 'individual', '자동응답', response);
    }, 1500);
  };

  // 프롤로그 시작 (SNS 메시지 튜토리얼)
  useEffect(() => {
    if (gameStage === 'prologue') {
      // Clear previous messages for a fresh tutorial start
      setMessages({ individual: [], investors: [], company: [] });
      setUnreadCounts({ individual: 0, investors: 0, company: 0 });

      setTimeout(() => {
        addMessage('individual', '친구 민지', '야! 너 요즘 회사만 다니느라 지쳐 보이드라 ㅠㅠ', false);
      }, 1000);
      setTimeout(() => {
        // Only positive choice remaining
        addMessage('individual', '친구 민지', '나 최근에 주식 시작했는데, 완전 신세계야! 너도 한번 해볼래? 🚀', false, [
          '정말요? 더 자세히 알려주세요'
        ]);
      }, 3000);
    }
  }, [gameStage]);

  // 주식 & 부동산 가격 업데이트
  useEffect(() => {
    const interval = setInterval(() => {
      if (gameStage === 'playing') {
        // 주식 가격 업데이트
        setStocks(prev => {
          const newStocks = { ...prev };
          Object.keys(newStocks).forEach(stockName => {
            const changePercent = (Math.random() - 0.5) * 0.06;
            const newPrice = Math.round(newStocks[stockName].price * (1 + changePercent));
            const finalPrice = Math.max(1000, newPrice);
            
            newStocks[stockName] = {
              ...newStocks[stockName],
              price: finalPrice,
              change: changePercent,
              history: [...newStocks[stockName].history.slice(-19), finalPrice]
            };
          });
          return newStocks;
        });
        
        // 부동산 가격 업데이트 (더 느리게)
        setRealEstateData(prev => {
          const newRealEstate = { ...prev };
          Object.keys(newRealEstate).forEach(propertyName => {
            const changePercent = (Math.random() - 0.5) * 0.02; // ±1%
            const newPrice = newRealEstate[propertyName].price * (1 + changePercent);
            
            newRealEstate[propertyName] = {
              ...newRealEstate[propertyName],
              price: Math.max(50000000, Math.round(newPrice)),
              change: changePercent
            };
          });
          return newRealEstate;
        });
      }
    }, 3000);

    return () => clearInterval(interval);
  }, [gameStage]);

  // 게임 시간 진행
  useEffect(() => {
    const interval = setInterval(() => {
      if (gameStage === 'playing') {
        setGameDay(prev => prev + 1);
        
        // 월급 지급
        if (gameDay % 30 === 0 && isEmployee) {
          setCash(prev => prev + 3000000);
          addMessage('individual', '회사', '월급 300만원이 입금되었습니다.');
        }
        
        // 부동산 임대수익 (월 1회)
        if (gameDay % 30 === 0) {
          let totalRent = 0;
          Object.entries(realEstate).forEach(([property, quantity]) => {
            const monthlyRent = realEstateData[property].price * realEstateData[property].rentYield / 12 * quantity;
            totalRent += monthlyRent;
          });
          
          if (totalRent > 0) {
            setCash(prev => prev + totalRent);
            addMessage('individual', '시스템', `💰 부동산 임대수익 ${formatMoney(totalRent)}이 입금되었습니다!`);
          }
        }
        
        // 스트레스 감소
        setStress(prev => Math.max(0, prev - 1));
        
        // 랜덤 메시지 - 더 풍성한 시나리오
        if (Math.random() < 0.1) {
          const messageScenarios = [
            // 개인 메시지들
            {
              type: 'individual',
              sender: '엄마',
              content: '유나야, 옆집 아줌마가 부동산이 더 안전하다던데? 집 한 채 사놓는 게 어때?',
              choices: ['엄마 말씀이 맞는 것 같아요', '주식이 더 수익성이 좋아요']
            },
            {
              type: 'individual',
              sender: '대학 선배',
              content: '후배야~ 내가 증권사에서 일하는데, 요즘 LG화학 좀 위험해 보여. 조심해.',
              choices: ['선배 정보 감사합니다!', '더 자세히 알려주세요'],
              stockImpact: { 'LG화학': -0.03 }
            },
            {
              type: 'individual',
              sender: '친구 민지',
              content: '오늘 점심 뭐 먹지? 주식 생각하느라 배고픈 것도 잊었네 ㅋㅋㅋ',
              choices: ['맛있는거 먹고 힘내!', '주식 생각은 그만!']
            },
            {
              type: 'individual',
              sender: '엄마',
              content: '유나야, 건강 잘 챙겨가면서 해. 돈도 좋지만 건강이 최고야.',
              choices: ['네 엄마 걱정마세요!', '알겠습니다.']
            },
            
            // 투자자 모임 메시지들
            {
              type: 'investors',
              sender: '투자고수',
              content: '여러분, 제가 20년 투자하면서 느낀 건데요. 분산투자가 정말 중요해요. 한 종목에 올인하지 마세요!',
              choices: ['정말 좋은 조언이네요!', '구체적인 비율이 궁금해요']
            },
            {
              type: 'investors',
              sender: '주린이123',
              content: '혹시 카카오 지금 사도 될까요? 너무 많이 떨어진 것 같은데...',
              choices: ['저도 고민 중이에요', '좀 더 지켜보세요']
            },
            {
              type: 'investors',
              sender: '부동산왕',
              content: '주식보다는 부동산이 안전하죠. 저는 강남 아파트 3채 있는데 매달 임대료만 1000만원이에요 ㅎㅎ',
              choices: ['부럽습니다!', '부동산도 관심있어요']
            },
            {
              type: 'investors',
              sender: '단타의신',
              content: '오늘 삼성전자 단타로 500만원 벌었다! 역시 단타가 최고지!',
              choices: ['대단하시네요!', '리스크가 크지 않나요?']
            },
            {
              type: 'investors',
              sender: '가치투자자',
              content: '기업의 가치를 보고 투자하세요. 단기적인 등락에 일희일비하지 마시고요.',
              choices: ['명심하겠습니다!', '어떤 기업이 좋을까요?']
            },
            
            // 회사 메시지들 (직장인일 때만)
            ...(isEmployee ? [{
              type: 'company',
              sender: '팀장',
              content: '유나씨, 요즘 업무에 집중 안되는 것 같은데 괜찮나요? 투자 때문에 신경쓰이시죠?',
              choices: ['죄송합니다, 집중하겠습니다', '괜찮습니다!']
            },
            {
              type: 'company',
              sender: '동료 수진',
              content: '유나야, 나도 주식 하고 싶은데 어떤 거 사면 좋을까? 초보자도 할 수 있어?',
              choices: ['같이 공부해봐요!', '신중하게 시작하세요']
            },
            {
              type: 'company',
              sender: '팀장',
              content: '다음주까지 보고서 제출인데, 유나씨 진행 상황 공유 부탁드립니다.',
              choices: ['네 팀장님 바로 공유드리겠습니다.', '조금 더 시간이 필요합니다.']
            },
            {
              type: 'company',
              sender: '동료 수진',
              content: '오늘 회식인데 올거지? 스트레스 풀자!',
              choices: ['당연하죠!', '죄송해요 선약이 있어요.']
            }
            ] : [])
          ];
          
          const randomScenario = messageScenarios[Math.floor(Math.random() * messageScenarios.length)];
          addMessage(randomScenario.type, randomScenario.sender, randomScenario.content, false, randomScenario.choices);
          
          // 주식에 영향을 주는 메시지일 경우
          if (randomScenario.stockImpact) {
            setTimeout(() => {
              setStocks(prev => {
                const newStocks = { ...prev };
                Object.entries(randomScenario.stockImpact).forEach(([stockName, impactPercent]) => {
                  if (newStocks[stockName]) {
                    const newPrice = Math.round(newStocks[stockName].price * (1 + impactPercent));
                    newStocks[stockName] = {
                      ...newStocks[stockName],
                      price: Math.max(1000, newPrice),
                      change: impactPercent,
                      history: [...newStocks[stockName].history.slice(-19), Math.max(1000, newPrice)]
                    };
                  }
                });
                return newStocks;
              });
            }, 3000);
          }
        }
        
        // 엔딩 체크 - 우선순위 순서대로
        const checkEndings = () => {
          // 1. 파산 (최우선)
          if (endings.bankruptcy.condition()) {
            setSelectedEnding('bankruptcy');
            setGameStage('ending');
            return;
          }
          
          // 2. 투자 중독
          if (endings.addictedTrader.condition()) {
            setSelectedEnding('addictedTrader');
            setGameStage('ending');
            return;
          }
          
          // 3. 회사 복직
          if (endings.backToWork.condition()) {
            setSelectedEnding('backToWork');
            setGameStage('ending');
            return;
          }
          
          // 4. 투자의 신 (10억)
          if (endings.megaSuccess.condition()) {
            setSelectedEnding('megaSuccess');
            setGameStage('ending');
            return;
          }
          
          // 5. 시그니엘 생활 (주식 중심 5억)
          if (endings.signielLife.condition()) {
            setSelectedEnding('signielLife');
            setGameStage('ending');
            return;
          }
          
          // 6. 하와이 생활 (부동산 중심 3억)
          if (endings.hawaiiLife.condition()) {
            setSelectedEnding('hawaiiLife');
            setGameStage('ending');
            return;
          }
          
          // 7. 평창동 생활
          if (endings.pyeongchangHouse.condition()) {
            setSelectedEnding('pyeongchangHouse');
            setGameStage('ending');
            return;
          }
        };
        
        checkEndings();
      }
    }, 4000);

    return () => clearInterval(interval);
  }, [gameStage, gameDay, isEmployee, getTotalAssets, stress, knowledge, endings, realEstate, realEstateData, portfolio, stocks]);

  // TV 채널 시청
  const watchChannel = (channelKey) => {
    playButtonClickSound(); // Play sound on channel selection
    setSelectedChannel(channelKey);
    const channel = tvChannels[channelKey];
    const randomMessage = channel.messages[Math.floor(Math.random() * channel.messages.length)];
    setTvMessage(randomMessage.text);
    
    // 좋은 뉴스일 때 배경 변경
    if (randomMessage.impact && Object.keys(randomMessage.impact).length > 0) {
      const hasPositiveImpact = Object.values(randomMessage.impact).some(impact => impact > 0);
      if (hasPositiveImpact) {
        setRecentGoodNews(true);
        setTimeout(() => setRecentGoodNews(false), 15000); // 15초 후 원래 배경으로
      }
    }
    
    // 채널별 효과
    switch(channelKey) {
      case 'gossip':
        setStress(prev => Math.min(100, prev + 5));
        break;
      case 'education':
        setKnowledge(prev => Math.min(100, prev + 3));
        break;
      case 'entertainment':
        setStress(prev => Math.max(0, prev - 5));
        break;
      default:
        break; // No default action for other channels
    }
    
    // 시장 영향 적용
    if (randomMessage.impact && Object.keys(randomMessage.impact).length > 0) {
      const shouldApply = Math.random() < randomMessage.accuracy;
      if (shouldApply) {
        setTimeout(() => {
          setStocks(prev => {
            const newStocks = { ...prev };
            Object.entries(randomMessage.impact).forEach(([stockName, impactPercent]) => {
              if (newStocks[stockName]) {
                const newPrice = Math.round(newStocks[stockName].price * (1 + impactPercent));
                newStocks[stockName] = {
                  ...newStocks[stockName],
                  price: Math.max(1000, newPrice),
                  change: impactPercent,
                  history: [...newStocks[stockName].history.slice(-19), Math.max(1000, newPrice)]
                };
              }
            });
            return newStocks;
          });
        }, 2000);
      }
    }
    
    setTimeout(() => {
      setTvMessage('');
    }, 5000);
  };

  // 주식 거래
  const tradeStock = (stockName, quantity, type) => {
    playButtonClickSound(); // Play sound on trade attempt
    if (type === 'buy') {
      const cost = stocks[stockName].price * quantity;
      if (cash >= cost) {
        setCash(prev => prev - cost);
        setPortfolio(prev => ({
          ...prev,
          [stockName]: (prev[stockName] || 0) + quantity
        }));
        setStress(prev => Math.min(100, prev + 3));
        setKnowledge(prev => Math.min(100, prev + 1));
        playTransactionSound(); // Play transaction sound on success
      } else {
        setShowAlertDialog(true);
        setAlertDialogContent({
          title: '자금 부족!',
          message: `주식을 매수하기 위한 현금이 부족합니다. 필요한 금액: ${formatMoney(cost - cash)}`
        });
      }
    } else { // type === 'sell'
      if ((portfolio[stockName] || 0) >= quantity) {
        const sale = stocks[stockName].price * quantity;
        setCash(prev => prev + sale);
        setPortfolio(prev => ({
          ...prev,
          [stockName]: prev[stockName] - quantity
        }));
        setStress(prev => Math.min(100, prev + 2));
        setKnowledge(prev => Math.min(100, prev + 1));
        playTransactionSound(); // Play transaction sound on success
      } else {
        setShowAlertDialog(true);
        setAlertDialogContent({
          title: '보유 수량 부족!',
          message: `매도하려는 주식(${stockName})의 수량이 부족합니다. 보유 수량: ${portfolio[stockName] || 0}주`
        });
      }
    }
  };

  // 메시지 전송
  const sendMessage = () => {
    playButtonClickSound(); // Play sound on message send attempt
    if (inputMessage.trim() && selectedChat) {
      addMessage(selectedChat, '유나', inputMessage, true);
      setInputMessage('');
      
      // 자동 응답
      setTimeout(() => {
        const responses = [
          '네, 알겠습니다!',
          '좋은 정보 감사합니다!',
          '현명한 판단이네요.',
          '저도 그렇게 생각해요!',
          '더 자세히 알려주세요!',
          '흥미롭네요.',
          '고민해볼게요.',
          '알겠습니다, 참고할게요.',
          '정말 기대되네요!',
          '최고의 선택입니다!',
          '힘내세요!',
          '화이팅!',
          '성투하세요!', // 성공 투자
          '대박나세요!',
          '조심하세요!'
        ];
        const response = responses[Math.floor(Math.random() * responses.length)]; // Random response
        addMessage(selectedChat, '자동응답', response);
      }, 2000);
    }
  };

  // 부동산 거래
  const tradeRealEstate = (propertyName, quantity, type) => {
    playButtonClickSound(); // Play sound on trade attempt
    if (type === 'buy') {
      const cost = realEstateData[propertyName].price * quantity;
      if (cash >= cost) {
        setCash(prev => prev - cost);
        setRealEstate(prev => ({
          ...prev,
          [propertyName]: (prev[propertyName] || 0) + quantity
        }));
        setStress(prev => Math.min(100, prev + 2));
        setKnowledge(prev => Math.min(100, prev + 1));
        playTransactionSound(); // Play transaction sound on success
      } else {
        setShowAlertDialog(true);
        setAlertDialogContent({
          title: '자금 부족!',
          message: `부동산을 매입하기 위한 현금이 부족합니다. 필요한 금액: ${formatMoney(cost - cash)}`
        });
      }
    } else { // type === 'sell'
      if ((realEstate[propertyName] || 0) >= quantity) {
        const sale = realEstateData[propertyName].price * quantity;
        setCash(prev => prev + sale);
        setRealEstate(prev => ({
          ...prev,
          [propertyName]: prev[propertyName] - quantity
        }));
        setStress(prev => Math.min(100, prev + 1));
        setKnowledge(prev => Math.min(100, prev + 1));
        playTransactionSound(); // Play transaction sound on success
      } else {
        setShowAlertDialog(true);
        setAlertDialogContent({
          title: '보유 수량 부족!',
          message: `매도하려는 부동산(${propertyName})의 수량이 부족합니다. 보유 수량: ${realEstate[propertyName] || 0}채`
        });
      }
    }
  };

  const formatMoney = (amount) => {
    if (amount >= 100000000) return `${(amount / 100000000).toFixed(1)}억원`;
    if (amount >= 10000) return `${(amount / 10000).toFixed(0)}만원`;
    return `${amount.toLocaleString()}원`;
  };

  // Initial Intro Screen
  if (gameStage === 'initialIntro') {
    return (
      <div
        className="max-w-sm mx-auto min-h-screen relative overflow-hidden font-inter flex flex-col items-center justify-end p-6"
        style={{
          backgroundImage: `url(https://imgur.com/sjQzlH5.jpg)`, // City night view background
          backgroundSize: 'cover',
          backgroundPosition: 'center bottom', // Adjusted to show more of the bottom
          backgroundRepeat: 'no-repeat',
          transition: 'background-image 1s ease-in-out' // Smooth transition for background image
        }}
      >
        {/* Floating Yuna Logo - Clickable to start game */}
        <img 
          src="https://imgur.com/Omc3nbn.jpg" 
          alt="유나 로고" 
          className="relative z-10 w-40 h-40 object-contain mb-16 animate-float cursor-pointer" // Added cursor-pointer
          onClick={() => {
            Tone.start(); // Start Tone.js context on user interaction
            setGameStage('prologue'); // Click logo to start
          }} 
          onError={(e) => { e.target.onerror = null; e.target.src="https://placehold.co/160x160/aabbcc/ffffff?text=Logo"; }} 
        />
      </div>
    );
  }

  // Tutorial Screen (prologue stage - Messenger style)
  if (gameStage === 'prologue') {
    return (
      <div className="max-w-sm mx-auto min-h-screen flex flex-col bg-gray-100 font-inter">
        {/* Status Bar */}
        <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 bg-opacity-90 shadow-lg">
          <div className="flex justify-between items-center p-3 text-white text-sm">
            <span>{new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}</span>
            <div className="flex items-center space-x-1">
              <span>●●●○○</span>
              <span className="ml-2">📶</span>
              <span>🔋100%</span>
            </div>
          </div>
        </div>

        {/* Chat Header */}
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '48px' }}> {/* Adjusted margin-top */}
          <h1 className="text-xl font-bold">친구 민지</h1>
        </div>
        
        {/* Chat Messages Area */}
        <div className="flex-1 p-4 overflow-y-auto custom-scrollbar">
          {messages.individual.map(msg => (
            <div key={msg.id} className={`mb-4 flex ${msg.isUser ? 'justify-end' : 'justify-start'}`}>
              {!msg.isUser && (
                <img 
                  src={senderProfiles[msg.sender] || "https://placehold.co/40x40/FFD700/000000?text=?"} // Use senderProfiles
                  alt="프로필" 
                  className="w-10 h-10 rounded-full mr-3 self-end"
                />
              )}
              <div className={`inline-block max-w-[70%] p-3 rounded-xl shadow-sm ${
                msg.isUser ? 'bg-green-500 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none'
              }`}>
                {!msg.isUser && <div className="text-xs font-bold mb-1 text-gray-700">{msg.sender}</div>}
                <div>{msg.content}</div>
                <div className={`text-xs opacity-70 mt-1 ${msg.isUser ? 'text-green-100' : 'text-gray-400'}`}>{msg.time}</div>
              </div>
            </div>
          ))}
          
          {/* Choices for user response */}
          {waitingForResponse && messages[waitingForResponse.type].find(m => m.id === waitingForResponse.messageId)?.choices && (
            <div className="mt-4 space-y-2 flex flex-col items-center">
              {messages[waitingForResponse.type].find(m => m.id === waitingForResponse.messageId).choices.map((choice, index) => (
                <button
                  key={index}
                  onClick={() => {
                    selectChoice(choice, waitingForResponse.messageId);
                    if (choice.includes('정말요? 더 자세히 알려주세요') || choice.includes('좋은 정보 감사해요!')) {
                      setGameStage('playing'); // Transition to playing stage after initial tutorial interaction
                    }
                  }}
                  className="w-11/12 bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-3 rounded-lg text-sm font-semibold hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 shadow-md"
                >
                  {choice}
                </button>
              ))}
            </div>
          )}
        </div>
        
        {/* Message Input */}
        <div className="p-4 border-t border-gray-200 flex bg-white shadow-inner">
          <input
            type="text"
            value={inputMessage}
            onChange={(e) => setInputMessage(e.target.value)} // Fixed setInputInput to setInputMessage
            placeholder="메시지를 입력하세요..."
            className="flex-1 border border-gray-300 rounded-full px-4 py-2 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
            disabled={waitingForResponse !== null} // Disable input if waiting for choice
          />
          <button
            onClick={sendMessage}
            className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-3 rounded-full shadow-md hover:from-green-600 hover:to-emerald-700 transition-all duration-300"
            disabled={waitingForResponse !== null} // Disable button if waiting for choice
          >
            <Send size={20} />
          </button>
        </div>
      </div>
    );
  }

  // Home Screen
  if (currentApp === 'home') {
    const returnRate = getCurrentReturnRate();
    const returnRateColor = returnRate >= 0 ? 'text-green-400' : 'text-red-400';

    return (
      <div
        className="max-w-sm mx-auto min-h-screen relative overflow-hidden font-inter"
        style={{
          backgroundImage: `url(${getBackgroundImage()})`,
          backgroundSize: 'cover',
          backgroundPosition: 'center bottom', // Adjusted to show more of the bottom
          backgroundRepeat: 'no-repeat',
          transition: 'background-image 1s ease-in-out' // Smooth transition for background image
        }}
      >
        {/* Removed dark overlay */}
        
        {/* Status Bar - Fixed at top */}
        <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-black bg-opacity-30 backdrop-blur-sm shadow-lg">
          <div className="flex justify-between items-center p-3 text-white text-sm">
            <span>9:41</span>
            <div className="flex items-center space-x-1">
              <span>●●●○○</span>
              <span className="ml-2">📶</span>
              <span>🔋100%</span>
            </div>
          </div>
        </div>

        {/* Game Info (Total Assets) with a box background */}
        <div className="relative z-10 text-center text-white pt-16 pb-4">
          <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-4 mx-4 shadow-lg border border-white border-opacity-30"> {/* Added box styling */}
            <div className="text-3xl font-bold drop-shadow-lg">총 자산: {formatMoney(getTotalAssets())}</div>
            {/* Summarized Wallet Info */}
            <div className="text-sm opacity-80 mt-2 space-y-1">
              <p>현금: {formatMoney(cash)}</p>
              <p>주식 자산: {formatMoney(Object.entries(portfolio).reduce((total, [stock, shares]) => total + (stocks[stock]?.price || 0) * shares, 0))}</p>
              <p>부동산 자산: {formatMoney(Object.entries(realEstate).reduce((total, [property, quantity]) => total + (realEstateData[property]?.price || 0) * quantity, 0))}</p>
            </div>
          </div>
        </div>

        {/* TV Broadcast Bubble - Positioned relative to flow, not fixed */}
        {tvMessage && (
          <div className="relative z-20 mx-4 mb-4 mt-2">
            <div className="bg-white rounded-xl p-3 shadow-xl border border-gray-200 animate-fade-in-up">
              <div className="text-sm text-gray-800 font-medium">{tvMessage}</div>
              <div className="absolute bottom-0 left-6 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-white transform translate-y-full"></div>
            </div>
          </div>
        )}

        {/* 하단 독 - All 5 main icons in one row, centered return rate */}
        <div className="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-40 bg-white bg-opacity-20 backdrop-blur-md rounded-t-3xl p-4 shadow-inner-lg">
          <div className="flex justify-around items-center">
            {/* Messages Button */}
            <button
              onClick={() => { playButtonClickSound(); setCurrentApp('messages'); }}
              className="flex flex-col items-center text-white bg-opacity-80 hover:bg-opacity-100 transition-opacity duration-200 relative p-2 rounded-xl"
            >
              <MessageCircle size={28} className="mb-1 text-green-300 drop-shadow-md" />
              <span className="text-xs font-semibold">메시지</span>
              {(unreadCounts.individual + unreadCounts.investors + unreadCounts.company) > 0 && (
                <div className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold animate-pulse z-20">
                  {unreadCounts.individual + unreadCounts.investors + unreadCounts.company}
                </div>
              )}
            </button>
            {/* Stocks Button */}
            <button
              onClick={() => { playButtonClickSound(); setCurrentApp('stocks'); }}
              className="flex flex-col items-center text-white bg-opacity-80 hover:bg-opacity-100 transition-opacity duration-200 p-2 rounded-xl"
            >
              <TrendingUp size={28} className="mb-1 text-blue-300 drop-shadow-md" />
              <span className="text-xs font-semibold">주식</span>
            </button>
            {/* Return Rate Display - Centered */}
            <div className="flex flex-col items-center text-white opacity-90 p-2 rounded-xl">
              <BarChart2 size={28} className={`mb-1 ${returnRateColor} drop-shadow-md`} />
              <span className="text-xs font-semibold">수익률</span>
              <span className={`text-sm font-bold ${returnRateColor}`}>
                {returnRate.toFixed(2)}%
              </span>
            </div>
            {/* Real Estate Button */}
            <button
              onClick={() => { playButtonClickSound(); setCurrentApp('realestate'); }}
              className="flex flex-col items-center text-white bg-opacity-80 hover:bg-opacity-100 transition-opacity duration-200 p-2 rounded-xl"
            >
              <Home size={28} className="mb-1 text-orange-300 drop-shadow-md" />
              <span className="text-xs font-semibold">부동산</span>
            </button>
            {/* TV Button */}
            <button
              onClick={() => { playButtonClickSound(); setCurrentApp('tv'); }}
              className="flex flex-col items-center text-white bg-opacity-80 hover:bg-opacity-100 transition-opacity duration-200 p-2 rounded-xl"
            >
              <Tv size={28} className="mb-1 text-purple-300 drop-shadow-md" />
              <span className="text-xs font-semibold">TV</span>
            </button>
          </div>
        </div>

        {/* Alert Dialog */}
        {showAlertDialog && (
          <AlertDialog
            title={alertDialogContent.title}
            message={alertDialogContent.message}
            onClose={() => setShowAlertDialog(false)}
          />
        )}
      </div>
    );
  }

  // 메시지 앱
  if (currentApp === 'messages') {
    if (!selectedChat) {
      return (
        <div className="max-w-sm mx-auto bg-gray-100 min-h-screen font-inter">
          {/* Status Bar */}
          <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 bg-opacity-90 shadow-lg">
            <div className="flex justify-between items-center p-3 text-white text-sm">
              <span>9:41</span>
              <div className="flex items-center space-x-1">
                <span>●●●○○</span>
                <span className="ml-2">📶</span>
                <span>🔋100%</span>
              </div>
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '48px' }}> {/* Adjusted margin-top */}
            <button onClick={() => { playButtonClickSound(); setCurrentApp('home'); }} className="mr-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-xl font-bold">메시지</h1>
          </div>
          
          <div className="divide-y divide-gray-200">
            <button
              onClick={() => {
                playButtonClickSound();
                setSelectedChat('individual');
                setUnreadCounts(prev => ({ ...prev, individual: 0 }));
              }}
              className="w-full p-4 flex items-center bg-white hover:bg-gray-50 transition-all duration-200 rounded-lg shadow-sm mb-2"
            >
              <div className="w-14 h-14 bg-blue-500 rounded-full flex items-center justify-center mr-4 text-2xl font-bold text-white shadow-md">
                👤
              </div>
              <div className="flex-1 text-left">
                <div className="font-bold text-gray-800">개인 메시지</div>
                <div className="text-sm text-gray-500">가족, 친구들과의 대화</div>
              </div>
              {unreadCounts.individual > 0 && (
                <div className="bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold animate-pulse">
                  {unreadCounts.individual}
                </div>
              )}
            </button>
            
            <button
              onClick={() => {
                playButtonClickSound();
                setSelectedChat('investors');
                setUnreadCounts(prev => ({ ...prev, investors: 0 }));
              }}
              className="w-full p-4 flex items-center bg-white hover:bg-gray-50 transition-all duration-200 rounded-lg shadow-sm mb-2"
            >
              <div className="w-14 h-14 bg-green-500 rounded-full flex items-center justify-center mr-4 text-2xl font-bold text-white shadow-md">
                💰
              </div>
              <div className="flex-1 text-left">
                <div className="font-bold text-gray-800">투자자 모임</div>
                <div className="text-sm text-gray-500">주식 투자 정보 공유</div>
              </div>
              {unreadCounts.investors > 0 && (
                <div className="bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold animate-pulse">
                  {unreadCounts.investors}
                </div>
              )}
            </button>
            
            {isEmployee && (
              <button
                onClick={() => {
                  playButtonClickSound();
                  setSelectedChat('company');
                  setUnreadCounts(prev => ({ ...prev, company: 0 }));
                }}
                className="w-full p-4 flex items-center bg-white hover:bg-gray-50 transition-all duration-200 rounded-lg shadow-sm"
              >
                <div className="w-14 h-14 bg-gray-500 rounded-full flex items-center justify-center mr-4 text-2xl font-bold text-white shadow-md">
                  🏢
                </div>
                <div className="flex-1 text-left">
                  <div className="font-bold text-gray-800">회사 단톡방</div>
                  <div className="text-sm text-gray-500">업무 관련 대화</div>
                </div>
                {unreadCounts.company > 0 && (
                  <div className="bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs font-bold animate-pulse">
                    {unreadCounts.company}
                  </div>
                )}
              </button>
            )}
          </div>
        </div>
      );
    }

    // 채팅 화면
    return (
      <div className="max-w-sm mx-auto bg-gray-100 min-h-screen flex flex-col font-inter">
        {/* Status Bar */}
        <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 bg-opacity-90 shadow-lg">
          <div className="flex justify-between items-center p-3 text-white text-sm">
            <span>9:41</span>
            <div className="flex items-center space-x-1">
              <span>●●●○○</span>
              <span className="ml-2">📶</span>
              <span>🔋100%</span>
            </div>
          </div>
        </div>
        
        <div className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '48px' }}> {/* Adjusted margin-top */}
          <button onClick={() => { playButtonClickSound(); setSelectedChat(null); }} className="mr-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200">
            <ArrowLeft size={24} />
          </button>
          <h1 className="text-xl font-bold">
            {selectedChat === 'individual' ? '개인 메시지' : 
             selectedChat === 'investors' ? '투자자 모임' : '회사 단톡방'}
          </h1>
        </div>
        
        <div className="flex-1 p-4 overflow-y-auto custom-scrollbar">
          {messages[selectedChat].map(msg => (
            <div key={msg.id} className={`mb-4 flex ${msg.isUser ? 'justify-end' : 'justify-start'}`}>
              {!msg.isUser && (
                <img 
                  src={senderProfiles[msg.sender] || "https://placehold.co/40x40/FFD700/000000?text=?"} // Use senderProfiles
                  alt="프로필" 
                  className="w-10 h-10 rounded-full mr-3 self-end"
                />
              )}
              <div className={`inline-block max-w-[70%] p-3 rounded-xl shadow-sm ${
                msg.isUser ? 'bg-green-500 text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-bl-none'
              }`}>
                {!msg.isUser && <div className="text-xs font-bold mb-1 text-gray-700">{msg.sender}</div>}
                <div>{msg.content}</div>
                <div className={`text-xs opacity-70 mt-1 ${msg.isUser ? 'text-green-100' : 'text-gray-400'}`}>{msg.time}</div>
              </div>
            </div>
          ))}
          
          {/* Choices for user response */}
          {waitingForResponse && messages[waitingForResponse.type].find(m => m.id === waitingForResponse.messageId)?.choices && (
            <div className="mt-4 space-y-2 flex flex-col items-center">
              {messages[waitingForResponse.type].find(m => m.id === waitingForResponse.messageId).choices.map((choice, index) => (
                <button
                  key={index}
                  onClick={() => selectChoice(choice, waitingForResponse.messageId)}
                  className="w-11/12 bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-3 rounded-lg text-sm font-semibold hover:from-blue-600 hover:to-indigo-700 transition-all duration-300 shadow-md"
                >
                  {choice}
                </button>
              ))}
            </div>
          )}
        </div>
        
        {/* Message Input */}
        <div className="p-4 border-t border-gray-200 flex bg-white shadow-inner">
          <input
            type="text"
            value={inputMessage}
            onChange={(e) => setInputMessage(e.target.value)}
            placeholder="메시지를 입력하세요..."
            className="flex-1 border border-gray-300 rounded-full px-4 py-2 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
            disabled={waitingForResponse !== null} // Disable input if waiting for choice
          />
          <button
            onClick={sendMessage}
            className="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-3 rounded-full shadow-md hover:from-green-600 hover:to-emerald-700 transition-all duration-300"
            disabled={waitingForResponse !== null} // Disable button if waiting for choice
          >
            <Send size={20} />
          </button>
        </div>
      </div>
    );
  }

  // 주식 앱
  if (currentApp === 'stocks') {
    if (!currentStockView) { // Stock list view
      return (
        <div className="max-w-sm mx-auto bg-gray-100 min-h-screen font-inter">
          {/* Status Bar */}
          <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 bg-opacity-90 shadow-lg">
            <div className="flex justify-between items-center p-3 text-white text-sm">
              <span>9:41</span>
              <div className="flex items-center space-x-1">
                <span>●●●○○</span>
                <span className="ml-2">📶</span>
                <span>🔋100%</span>
              </div>
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '50px' }}>
            <button onClick={() => { playButtonClickSound(); setCurrentApp('home'); }} className="mr-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-xl font-bold">주식</h1>
          </div>
          
          <div className="p-4">
            <div className="bg-white rounded-xl p-4 mb-4 shadow-lg border border-gray-200">
              <div className="text-sm text-gray-600">보유 현금</div>
              <div className="text-3xl font-bold text-blue-700">{formatMoney(cash)}</div>
            </div>
            
            <div className="space-y-4">
              {Object.entries(stocks).map(([stockName, data]) => (
                <button
                  key={stockName}
                  onClick={() => { playButtonClickSound(); setCurrentStockView(stockName); }}
                  className="w-full bg-white border rounded-xl p-4 shadow-lg hover:shadow-xl transition-all duration-300 text-left transform hover:scale-[1.01]"
                >
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-lg text-gray-800">{stockName}</span>
                    <div className="text-right">
                      <div className="font-bold text-xl text-gray-900">{data.price.toLocaleString()}원</div>
                      <div className={`text-sm font-semibold ${data.change >= 0 ? 'text-red-500' : 'text-blue-500'}`}>
                        {data.change >= 0 ? '▲' : '▼'} {(Math.abs(data.change) * 100).toFixed(2)}%
                      </div>
                    </div>
                  </div>
                  
                  {/* 미니 선 그래프 */}
                  <div className="mb-3">
                    <svg width="100%" height="32" className="overflow-visible">
                      {(() => {
                        const miniHistory = data.history.slice(-10);
                        const maxPrice = Math.max(...miniHistory);
                        const minPrice = Math.min(...miniHistory);
                        const priceRange = maxPrice - minPrice || 1;
                        const width = 200;
                        const height = 24;
                        
                        const points = miniHistory.map((price, index) => {
                          const x = (index / (miniHistory.length - 1)) * width;
                          const y = ((maxPrice - price) / priceRange) * height;
                          return `${x},${y}`;
                        }).join(' ');
                        
                        return (
                          <polyline 
                            points={points}
                            fill="none"
                            stroke={data.change >= 0 ? "#ef4444" : "#3b82f6"}
                            strokeWidth="1.5"
                            strokeLinecap="round"
                            strokeLinejoin="round"
                          />
                        );
                      })()}
                    </svg>
                  </div>
                  
                  <div className="flex justify-between items-center text-sm text-gray-600">
                    <span>보유: <span className="font-semibold">{portfolio[stockName] || 0}주</span></span>
                    <span className="text-blue-600 font-semibold">상세보기 →</span>
                  </div>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    } else { // Stock detail view
      const stockData = stocks[currentStockView];
      return (
        <div className="max-w-sm mx-auto bg-gray-100 min-h-screen font-inter">
          {/* Status Bar */}
          <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 bg-opacity-90 shadow-lg">
            <div className="flex justify-between items-center p-3 text-white text-sm">
              <span>9:41</span>
              <div className="flex items-center space-x-1">
                <span>●●●○○</span>
                <span className="ml-2">📶</span>
                <span>🔋100%</span>
              </div>
            </div>
          </div>
          
          <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '50px' }}>
            <button onClick={() => { playButtonClickSound(); setCurrentStockView(null); }} className="mr-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-xl font-bold">{currentStockView}</h1>
          </div>
          
          <div className="p-4">
            {/* 현재 가격 */}
            <div className="bg-white rounded-xl p-4 mb-4 shadow-lg border border-gray-200">
              <div className="text-center">
                <div className="text-4xl font-extrabold text-gray-900 mb-1">{stockData.price.toLocaleString()}원</div>
                <div className={`text-xl font-semibold ${stockData.change >= 0 ? 'text-red-500' : 'text-blue-500'}`}>
                  {stockData.change >= 0 ? '▲' : '▼'} {(Math.abs(stockData.change) * 100).toFixed(2)}%
                </div>
              </div>
            </div>
            
            {/* 상세 차트 - 선 그래프 */}
            <div className="bg-white border rounded-xl p-4 mb-4 shadow-lg">
              <h3 className="font-bold text-gray-800 mb-3 text-lg">가격 추이</h3>
              <div className="relative">
                <svg width="100%" height="120" className="overflow-visible">
                  <defs>
                    <linearGradient id="priceGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                      <stop offset="0%" stopColor={stockData.change >= 0 ? "#ef4444" : "#3b82f6"} stopOpacity="0.3"/>
                      <stop offset="100%" stopColor={stockData.change >= 0 ? "#ef4444" : "#3b82f6"} stopOpacity="0.1"/>
                    </linearGradient>
                  </defs>
                  
                  {(() => {
                    const maxPrice = Math.max(...stockData.history);
                    const minPrice = Math.min(...stockData.history);
                    const priceRange = maxPrice - minPrice || 1;
                    const width = 280; // SVG 너비
                    const height = 80; // 그래프 높이
                    const padding = 10;
                    
                    // 포인트 생성
                    const points = stockData.history.map((price, index) => {
                      const x = padding + (index / (stockData.history.length - 1)) * (width - 2 * padding);
                      const y = padding + ((maxPrice - price) / priceRange) * height;
                      return `${x},${y}`;
                    }).join(' ');
                    
                    // 영역 채우기를 위한 포인트
                    const areaPoints = `${padding},${height + padding} ${points} ${width - padding},${height + padding}`;
                    
                    return (
                      <>
                        {/* 영역 채우기 */}
                        <polygon 
                          points={areaPoints} 
                          fill="url(#priceGradient)"
                        />
                        {/* 선 그래프 */}
                        <polyline 
                          points={points}
                          fill="none"
                          stroke={stockData.change >= 0 ? "#ef4444" : "#3b82f6"}
                          strokeWidth="2"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        />
                        {/* 데이터 포인트 */}
                        {stockData.history.map((price, index) => {
                          const x = padding + (index / (stockData.history.length - 1)) * (width - 2 * padding);
                          const y = padding + ((maxPrice - price) / priceRange) * height;
                          return (
                            <circle
                              key={index}
                              cx={x}
                              cy={y}
                              r="3"
                              fill={stockData.change >= 0 ? "#ef4444" : "#3b82f6"}
                              className="hover:r-4 transition-all duration-200 cursor-pointer"
                            >
                              <title>{price.toLocaleString()}원</title> 
                            </circle>
                          );
                        })}
                      </>
                    );
                  })()}
                </svg>
              </div>
              <div className="text-xs text-gray-500 mt-2 text-center">
                최근 {stockData.history.length}일간 데이터
              </div>
            </div>
            
            {/* 보유 현황 */}
            <div className="bg-white rounded-xl p-4 mb-4 shadow-lg border border-gray-200">
              <div className="text-sm text-gray-600">보유 주식</div>
              <div className="text-3xl font-bold text-blue-700">{portfolio[currentStockView] || 0}주</div>
              <div className="text-base text-gray-600">
                평가금액: <span className="font-semibold">{formatMoney((portfolio[currentStockView] || 0) * stockData.price)}</span>
              </div>
            </div>
            
            {/* 거래 버튼들 */}
            <div className="space-y-6">
              <div>
                <div className="text-xl font-bold text-red-600 mb-3">매수</div>
                <div className="grid grid-cols-2 gap-3">
                  {[1, 5, 10, 20].map(quantity => (
                    <button
                      key={quantity}
                      onClick={() => tradeStock(currentStockView, quantity, 'buy')}
                      className="bg-red-500 text-white py-4 px-4 rounded-xl font-bold text-lg shadow-md hover:bg-red-600 transition-all duration-300 transform hover:scale-105"
                    >
                      {quantity}주 매수<br/>
                      <span className="text-sm opacity-90">
                        {formatMoney(stockData.price * quantity)}
                      </span>
                    </button>
                  ))}
                </div>
              </div>
              
              <div>
                <div className="text-xl font-bold text-blue-600 mb-3">매도</div>
                <div className="grid grid-cols-2 gap-3">
                  {[1, 5, 10, 20].map(quantity => (
                    <button
                      key={quantity}
                      onClick={() => tradeStock(currentStockView, quantity, 'sell')}
                      className="bg-blue-500 text-white py-4 px-4 rounded-xl font-bold text-lg shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105"
                      disabled={(portfolio[currentStockView] || 0) < quantity}
                    >
                      {quantity}주 매도<br/>
                      <span className="text-sm opacity-90">
                        {formatMoney(stockData.price * quantity)}
                      </span>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>
          {/* Alert Dialog */}
          {showAlertDialog && (
            <AlertDialog
              title={alertDialogContent.title}
              message={alertDialogContent.message}
              onClose={() => setShowAlertDialog(false)}
            />
          )}
        </div>
      );
    }
    
    // 주식 목록 화면
    return (
      <div className="max-w-sm mx-auto bg-gray-100 min-h-screen font-inter">
        {/* Status Bar */}
        <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 bg-opacity-90 shadow-lg">
          <div className="flex justify-between items-center p-3 text-white text-sm">
            <span>9:41</span>
            <div className="flex items-center space-x-1">
              <span>●●●○○</span>
              <span className="ml-2">📶</span>
              <span>🔋100%</span>
            </div>
          </div>
        </div>
        
        <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '50px' }}>
          <button onClick={() => { playButtonClickSound(); setCurrentApp('home'); }} className="mr-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200">
            <ArrowLeft size={24} />
          </button>
          <h1 className="text-xl font-bold">주식</h1>
        </div>
        
        <div className="p-4">
          <div className="bg-white rounded-xl p-4 mb-4 shadow-lg border border-gray-200">
            <div className="text-sm text-gray-600">보유 현금</div>
            <div className="text-3xl font-bold text-blue-700">{formatMoney(cash)}</div>
          </div>
          
          <div className="space-y-4">
            {Object.entries(stocks).map(([stockName, data]) => (
              <button
                key={stockName}
                onClick={() => { playButtonClickSound(); setCurrentStockView(stockName); }}
                className="w-full bg-white border rounded-xl p-4 shadow-lg hover:shadow-xl transition-all duration-300 text-left transform hover:scale-[1.01]"
              >
                <div className="flex justify-between items-center mb-2">
                  <span className="font-bold text-lg text-gray-800">{stockName}</span>
                  <div className="text-right">
                    <div className="font-bold text-xl text-gray-900">{data.price.toLocaleString()}원</div>
                    <div className={`text-sm font-semibold ${data.change >= 0 ? 'text-red-500' : 'text-blue-500'}`}>
                      {data.change >= 0 ? '▲' : '▼'} {(Math.abs(data.change) * 100).toFixed(2)}%
                    </div>
                  </div>
                </div>
                
                {/* 미니 선 그래프 */}
                <div className="mb-3">
                  <svg width="100%" height="32" className="overflow-visible">
                    {(() => {
                      const miniHistory = data.history.slice(-10);
                      const maxPrice = Math.max(...miniHistory);
                      const minPrice = Math.min(...miniHistory);
                      const priceRange = maxPrice - minPrice || 1;
                      const width = 200;
                      const height = 24;
                      
                      const points = miniHistory.map((price, index) => {
                        const x = (index / (miniHistory.length - 1)) * width;
                        const y = ((maxPrice - price) / priceRange) * height;
                        return `${x},${y}`;
                      }).join(' ');
                      
                      return (
                        <polyline 
                          points={points}
                          fill="none"
                          stroke={data.change >= 0 ? "#ef4444" : "#3b82f6"}
                          strokeWidth="1.5"
                          strokeLinecap="round"
                          strokeLinejoin="round"
                        />
                      );
                    })()}
                  </svg>
                </div>
                
                <div className="flex justify-between items-center text-sm text-gray-600">
                  <span>보유: <span className="font-semibold">{portfolio[stockName] || 0}주</span></span>
                  <span className="text-blue-600 font-semibold">상세보기 →</span>
                </div>
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // 부동산 앱
  if (currentApp === 'realestate') {
    return (
      <div className="max-w-sm mx-auto bg-gray-100 min-h-screen font-inter">
          {/* Status Bar */}
          <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 bg-opacity-90 shadow-lg">
            <div className="flex justify-between items-center p-3 text-white text-sm">
              <span>9:41</span>
              <div className="flex items-center space-x-1">
                <span>●●●○○</span>
                <span className="ml-2">📶</span>
                <span>🔋100%</span>
              </div>
            </div>
          </div>
        
        <div className="bg-gradient-to-r from-orange-500 to-red-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '50px' }}>
            <button onClick={() => { playButtonClickSound(); setCurrentApp('home'); }} className="mr-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-xl font-bold">부동산</h1>
          </div>
        
        <div className="p-4">
          <div className="bg-white rounded-xl p-4 mb-4 shadow-lg border border-gray-200">
            <div className="text-sm text-gray-600">보유 현금</div>
            <div className="text-3xl font-bold text-orange-700">{formatMoney(cash)}</div>
          </div>
          
          <div className="space-y-4">
            {Object.entries(realEstateData).map(([propertyName, data]) => (
              <div key={propertyName} className="bg-white border rounded-xl p-4 shadow-lg transform hover:scale-[1.01] transition-all duration-300">
                <div className="flex justify-between items-center mb-2">
                  <div>
                    <div className="font-bold text-lg text-gray-800">{propertyName}</div>
                    <div className="text-xs text-gray-500">{data.description}</div>
                  </div>
                  <div className="text-right">
                    <div className="font-bold text-xl text-gray-900">{formatMoney(data.price)}</div>
                    <div className={`text-sm font-semibold ${data.change >= 0 ? 'text-red-500' : 'text-blue-500'}`}>
                      {data.change >= 0 ? '▲' : '▼'} {(Math.abs(data.change) * 100).toFixed(2)}%
                    </div>
                  </div>
                </div>
                
                <div className="bg-gray-50 rounded-lg p-3 mb-3 shadow-inner">
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-gray-600">연 수익률</span>
                      <span className="font-bold text-green-600">{(data.rentYield * 100).toFixed(1)}%</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">월 임대료</span>
                      <span className="font-bold text-green-600">
                        {formatMoney(data.price * data.rentYield / 12)}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">보유</span>
                      <span className="font-bold">{realEstate[propertyName] || 0}채</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600">총 가치</span>
                      <span className="font-bold text-orange-700">
                        {formatMoney(data.price * (realEstate[propertyName] || 0))}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div className="space-y-3">
                  <div className="text-base font-bold text-red-600">매입</div>
                  <div className="grid grid-cols-2 gap-3">
                    {[1, 2].map(quantity => (
                      <button
                        key={quantity}
                        onClick={() => tradeRealEstate(propertyName, quantity, 'buy')}
                        className="bg-red-500 text-white py-3 px-3 rounded-xl text-base font-bold shadow-md hover:bg-red-600 transition-all duration-300 transform hover:scale-105"
                      >
                        {quantity}채 매입<br/>
                        <span className="text-xs opacity-90">
                          {formatMoney(data.price * quantity)}
                        </span>
                      </button>
                    ))}
                  </div>
                  
                  <div className="text-base font-bold text-blue-600">매도</div>
                  <div className="grid grid-cols-2 gap-3">
                    {[1, 2].map(quantity => (
                      <button
                        key={quantity}
                        onClick={() => tradeRealEstate(propertyName, quantity, 'sell')}
                        className="bg-blue-500 text-white py-3 px-3 rounded-xl text-base font-bold shadow-md hover:bg-blue-600 transition-all duration-300 transform hover:scale-105"
                        disabled={(realEstate[propertyName] || 0) < quantity}
                      >
                        {quantity}채 매도<br/>
                        <span className="text-xs opacity-90">
                          {formatMoney(data.price * quantity)}
                        </span>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
        {/* Alert Dialog */}
        {showAlertDialog && (
          <AlertDialog
            title={alertDialogContent.title}
            message={alertDialogContent.message}
            onClose={() => setShowAlertDialog(false)}
          />
        )}
      </div>
    );
  }

  // TV 앱
  if (currentApp === 'tv') {
    return (
      <div className="max-w-sm mx-auto bg-gray-900 min-h-screen font-inter">
          {/* Status Bar */}
          <div className="fixed top-0 left-1/2 transform -translate-x-1/2 w-full max-w-sm z-50 bg-gray-900 shadow-lg">
            <div className="flex justify-between items-center p-3 text-white text-sm">
              <span>9:41</span>
              <div className="flex items-center space-x-1">
                <span>●●●○○</span>
                <span className="ml-2">📶</span>
                <span>🔋100%</span>
              </div>
            </div>
          </div>
        
        <div className="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4 flex items-center shadow-md" style={{ marginTop: '50px' }}>
            <button onClick={() => { playButtonClickSound(); setCurrentApp('home'); }} className="mr-4 p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all duration-200">
              <ArrowLeft size={24} />
            </button>
            <h1 className="text-xl font-bold">📺 TV</h1>
          </div>
        
          <div className="grid grid-cols-1 gap-4 p-4"> {/* Added p-4 here for consistency */}
            {Object.entries(tvChannels).map(([key, channel]) => (
              <button
                key={key}
                onClick={() => watchChannel(key)}
                className={`p-5 rounded-xl text-left transition-all duration-300 shadow-lg ${
                  selectedChannel === key 
                    ? 'bg-gradient-to-r from-red-600 to-rose-700 text-white transform scale-[1.02]' 
                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                }`}
              >
                <div className="flex items-center mb-2">
                  <span className="text-3xl mr-4">{channel.icon}</span>
                  <div>
                    <div className="font-bold text-lg">{channel.name}</div>
                    <div className="text-sm opacity-80">{channel.description}</div>
                  </div>
                  {selectedChannel === key && (
                    <Volume2 size={24} className="ml-auto text-yellow-300 animate-pulse" />
                  )}
                </div>
              </button>
            ))}
          </div>
          
          {selectedChannel && (
            <div className="mt-6 bg-gray-800 rounded-xl p-5 shadow-lg border border-gray-700 mx-4"> {/* Added mx-4 for consistency */}
              <div className="text-white text-center">
                <div className="text-xl font-bold mb-2">
                  {tvChannels[selectedChannel].name} 시청 중
                </div>
                <div className="text-base opacity-80">
                  {tvMessage && (
                    <div className="mt-4 p-3 bg-gray-700 rounded-lg text-sm italic">
                      "{tvMessage}"
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
    );
  }

  // 엔딩 화면
  if (gameStage === 'ending' && selectedEnding) {
    const ending = endings[selectedEnding];
    const [showEpilogue, setShowEpilogue] = useState(false);
    
    return (
      <div 
        className="w-full h-screen flex flex-col items-center justify-center text-white text-center p-6 relative overflow-hidden font-inter"
        style={{
          backgroundImage: `url(${ending.backgroundImage})`,
          backgroundSize: 'cover',
          backgroundPosition: 'center',
          backgroundRepeat: 'no-repeat'
        }}
      >
        {/* 배경 오버레이 */}
        <div className="absolute inset-0 bg-black bg-opacity-60"></div>
        
        {/* Status Bar */}
        <div className="fixed top-0 left-0 w-full z-50 bg-black bg-opacity-40 backdrop-blur-sm shadow-lg">
          <div className="flex justify-between items-center p-3 text-white text-sm max-w-sm mx-auto">
            <span>9:41</span>
            <div className="flex items-center space-x-1">
              <span>●●●○○</span>
              <span className="ml-2">📶</span>
              <span>🔋100%</span>
            </div>
          </div>
        </div>
        
        <div className="relative z-10 max-w-md w-full mx-auto">
          {!showEpilogue ? (
            // 엔딩 화면
            <>
              <div className="text-8xl mb-8 animate-fade-in-up">{ending.image}</div>
              <h1 className="text-4xl font-extrabold mb-6 drop-shadow-lg animate-fade-in-up-slow">{ending.title}</h1>
              <p className="text-xl mb-10 leading-relaxed drop-shadow-md animate-fade-in-up-slower">{ending.description}</p>
              <div className="space-y-4 w-full">
                <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 border border-white border-opacity-30 shadow-lg animate-fade-in">
                  <div className="text-sm opacity-90">최종 자산</div>
                  <div className="text-3xl font-bold">{formatMoney(getTotalAssets())}</div>
                </div>
                <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 border border-white border-opacity-30 shadow-lg animate-fade-in delay-100">
                  <div className="text-sm opacity-90">플레이 시간</div>
                  <div className="text-2xl font-bold">{gameDay}일</div>
                </div>
                
                {ending.epilogue && (
                  <button
                    onClick={() => { playButtonClickSound(); setShowEpilogue(true); }}
                    className="w-full bg-white bg-opacity-30 backdrop-blur-sm text-white py-4 rounded-xl font-bold text-lg hover:bg-opacity-40 transition-all duration-300 border border-white border-opacity-30 shadow-lg animate-fade-in delay-200"
                  >
                    📖 에피로그 보기
                  </button>
                )}
                
                <button
                  onClick={() => { playButtonClickSound(); window.location.reload(); }}
                  className="w-full bg-white text-gray-900 py-4 rounded-xl font-bold text-lg hover:bg-gray-100 transition-all duration-300 shadow-xl animate-fade-in delay-300"
                >
                  🔄 다시 시작하기
                </button>
              </div>
            </>
          ) : (
            // 에피로그 화면
            <>
              <div className="text-6xl mb-6 animate-fade-in-up">{ending.image}</div>
              <h2 className="text-3xl font-extrabold mb-8 drop-shadow-lg animate-fade-in-up-slow">{ending.epilogue.title}</h2>
              
              <div className="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-6 mb-6 text-left border border-white border-opacity-30 shadow-lg animate-fade-in">
                <p className="text-lg leading-relaxed italic drop-shadow-sm">
                  "{ending.epilogue.content}"
                </p>
              </div>
              
              <div className="bg-white bg-opacity-15 backdrop-blur-sm rounded-xl p-6 mb-8 text-left border border-white border-opacity-20 shadow-lg animate-fade-in delay-100">
                <h3 className="text-xl font-bold mb-4 drop-shadow-sm">그 후의 이야기</h3>
                <p className="text-base leading-relaxed drop-shadow-sm">
                  {ending.epilogue.afterLife}
                </p>
              </div>
              
              <div className="space-y-4">
                <button
                  onClick={() => { playButtonClickSound(); setShowEpilogue(false); }}
                  className="w-full bg-white bg-opacity-30 backdrop-blur-sm text-white py-4 rounded-xl font-bold hover:bg-opacity-40 transition-all duration-300 border border-white border-opacity-30 shadow-lg animate-fade-in delay-200"
                >
                  ← 뒤로 가기
                </button>
                <button
                  onClick={() => { playButtonClickSound(); window.location.reload(); }}
                  className="w-full bg-white text-gray-900 py-4 rounded-xl font-bold text-lg hover:bg-gray-100 transition-all duration-300 shadow-xl animate-fade-in delay-300"
                >
                  🔄 다시 시작하기
                </button>
              </div>
            </>
          )}
        </div>
      </div>
    );
  }

  return null;
};

export default YunaStockGame;
�